{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="text-center mb-4">
                    <i class="fas fa-upload me-2"></i>Upload APK for Security Scan
                </h2>
                <p class="text-center text-muted mb-4">
                    Select an APK file to scan for malicious behavior
                </p>
                
<form method="POST" enctype="multipart/form-data" id="uploadForm">
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h4>Drop your APK file here</h4>
        <p>or click to browse</p>
        <input type="file" name="file" id="fileInput" accept=".apk" style="display: none;" required>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Maximum file size: 100MB â€¢ Supported format: .apk
            </small>
        </div>
    </div>
    
    <div class="file-info" id="fileInfo" style="display: none;">
        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="fas fa-file me-2"></i>Selected File:</h6>
                <p id="fileName" class="mb-2"></p>
                <p id="fileSize" class="text-muted mb-0"></p>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
            <i class="fas fa-search me-2"></i>Start Security Scan
        </button>
    </div>
</form>

<!-- Progress Bar -->
<div class="progress mt-4" id="progressBar" style="display: none;">
    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
</div>

<!-- Scanning Animation -->
<div class="text-center mt-4" id="scanningStatus" style="display: none;">
    <div class="scanning">
        <i class="fas fa-search fa-2x text-primary mb-3"></i>
        <h5>Analyzing APK... This may take a few moments.</h5>
        <p class="text-muted">Please don't close this window</p>
    </div>
</div>
            </div>
        </div>
        
        <!-- Security Tips -->
        <div class="card mt-4">
            <div class="card-body">
                <h5><i class="fas fa-lightbulb me-2"></i>Security Tips</h5>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Only download APKs from trusted sources</li>
                    <li><i class="fas fa-check text-success me-2"></i>Always scan APKs before installation</li>
                    <li><i class="fas fa-check text-success me-2"></i>Check app permissions carefully</li>
                    <li><i class="fas fa-check text-success me-2"></i>Keep your device updated</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const scanningStatus = document.getElementById('scanningStatus');
    
    // Click to upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#5a67d8';
        uploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.3)';
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#667eea';
        uploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#667eea';
        uploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        if (file.name.toLowerCase().endsWith('.apk')) {
            fileName.textContent = file.name;
            fileSize.textContent = `Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
            fileInfo.style.display = 'block';
            submitBtn.disabled = false;
        } else {
            alert('Please select a valid APK file.');
            fileInput.value = '';
            fileInfo.style.display = 'none';
            submitBtn.disabled = true;
        }
    }
    
// Form submission
uploadForm.addEventListener('submit', (e) => {
    if (!fileInput.files.length) {
        e.preventDefault();
        alert('Please select an APK file first.');
        return;
    }
    
    // Show progress and scanning animation
    progressBar.style.display = 'block';
    scanningStatus.style.display = 'block';
    submitBtn.disabled = true;
    
    // Animate progress bar
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 90) {
            clearInterval(progressInterval);
            progress = 90;
        }
        document.querySelector('.progress-bar').style.width = progress + '%';
    }, 200);
    
    // Disable form submission after first submit to prevent multiple uploads
    uploadForm.removeEventListener('submit', arguments.callee);
    
    // Add error handling for network or server errors
    fetch(uploadForm.action, {
        method: 'POST',
        body: new FormData(uploadForm)
    }).then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    }).then(data => {
        // Redirect or show success message
        window.location.href = data;
    }).catch(error => {
        alert('Error uploading file: ' + error.message);
        progressBar.style.display = 'none';
        scanningStatus.style.display = 'none';
        submitBtn.disabled = false;
    });
    
    // Prevent default form submission
    e.preventDefault();
});
</script>
{% endblock %}
